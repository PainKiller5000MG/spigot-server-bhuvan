package net.minecraft.world.level.gameevent;

import java.util.function.Consumer;
import net.minecraft.core.SectionPos;
import net.minecraft.server.level.ServerLevel;
import net.minecraft.world.level.LevelReader;
import net.minecraft.world.level.chunk.ChunkAccess;
import net.minecraft.world.level.chunk.status.ChunkStatus;
import org.jspecify.annotations.Nullable;

public class DynamicGameEventListener<T extends GameEventListener> {

    private final T listener;
    private @Nullable SectionPos lastSection;

    public DynamicGameEventListener(T listener) {
        this.listener = listener;
    }

    public void add(ServerLevel level) {
        this.move(level);
    }

    public T getListener() {
        return this.listener;
    }

    public void remove(ServerLevel level) {
        ifChunkExists(level, this.lastSection, (gameeventlistenerregistry) -> {
            gameeventlistenerregistry.unregister(this.listener);
        });
    }

    public void move(ServerLevel level) {
        this.listener.getListenerSource().getPosition(level).map(SectionPos::of).ifPresent((sectionpos) -> {
            if (this.lastSection == null || !this.lastSection.equals(sectionpos)) {
                ifChunkExists(level, this.lastSection, (gameeventlistenerregistry) -> {
                    gameeventlistenerregistry.unregister(this.listener);
                });
                this.lastSection = sectionpos;
                ifChunkExists(level, this.lastSection, (gameeventlistenerregistry) -> {
                    gameeventlistenerregistry.register(this.listener);
                });
            }

        });
    }

    private static void ifChunkExists(LevelReader level, @Nullable SectionPos sectionPos, Consumer<GameEventListenerRegistry> action) {
        if (sectionPos != null) {
            ChunkAccess chunkaccess = level.getChunk(sectionPos.x(), sectionPos.z(), ChunkStatus.FULL, false);

            if (chunkaccess != null) {
                action.accept(chunkaccess.getListenerRegistry(sectionPos.y()));
            }

        }
    }
}
